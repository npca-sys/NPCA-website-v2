<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="ja" lang="ja" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-script-type" content="text/javascript" />
<meta name="author" content="まいん" />
<meta name="copyright" content="(c) Copyright 2010 npca &amp; Mine Studio. All rights reserved." />
<meta name="description" content="灘校パソコン研究部のウェブサイトです。" />
<meta name="keywords" content="npca,パソコン,コンピュータ,クラブ,nada,灘,灘校,中学,高校,web,プログラム,プログラミング,program,部活,trlocon,電脳,電脳科学研究部,部誌" />
<meta name="name" content="npca" />
<meta name="robots" content="ALL" />
<meta name="title" content="npca's WebSite" />
<link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="index" href="index.html" />
<link rev="made" href="mailto:naclubkaityo@gmail.com" />
<script type="text/javascript">
<!--
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4970457-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
// -->
</script>
<link rel="stylesheet" type="text/css" media="screen, tv" href="npca/css/basic.css" charset="UTF-8" />
<title>npca's WebSite - 部誌 - CUIで始める動画変換
</title>
</head>
<body>
<div class="cont">
<div class="label">
<img src="npca/image/normal/label/line4.png" alt="ライン" width="800" height="100" />
<img src="npca/image/normal/label/magazine_label.png" alt="タイトル" width="800" height="100" />
<a href="index.html" title="トップページ"><img src="npca/image/normal/label/title_text.png" alt="npca's Web Site" width="320" height="100" /></a>
</div>
<ul class="contlink">
<li id="cont_npca"><a href="index.html%3Fnpca.html" title="灘校パソコン研究部の活動趣旨など"><img src="npca/image/normal/cont/npca_text.png" alt="npcaとは？" width="160" height="40" /></a>
<ul class="pull_down">
<li class="menu_top"><p>menu_top</p></li>
<li><a href="index.html%3Fnpca=style.html" title="npcaの活動のスタイル">活動スタイル</a></li>
<li><a href="index.html%3Fnpca=leader_greet.html" title="npca部長の挨拶">部長挨拶</a></li>
<li><a href="index.html%3Fnpca=acc_greet.html" title="npca会計担当の挨拶">会計担当挨拶</a></li>
<li><a href="index.html%3Fnpca=sv_ad_greet.html" title="npcaサーバー管理者の挨拶">サーバー管理者挨拶</a></li>
<li><a href="index.html%3Fnpca=accounting.html" title="npcaの会計関連情報">会計情報</a></li>
<li><a href="index.html%3Fnpca=machine.html" title="npcaの所有しているマシンの情報">マシン情報</a></li>
<li class="menu_bottom"><p>menu_bottom</p></li>
</ul>
</li>
<li id="cont_site"><a href="index.html%3Fsite.html" title="このサイトに関する説明など"><img src="npca/image/normal/cont/site_text.png" alt="このサイトについて" width="160" height="40" /></a>
<ul class="pull_down">
<li class="menu_top"><p>menu_top</p></li>
<li><a href="index.html%3Fsite=update.html" title="本サイトの更新履歴">更新履歴</a></li>
<li><a href="index.html%3Fsite=oldsite.html" title="旧サイトの紹介">旧サイト紹介</a></li>
<li><a href="index.html%3Fsite=intel.html" title="知的所有権について">知的所有権</a></li>
<li class="menu_bottom"><p>menu_bottom</p></li>
</ul>
</li>
<li id="cont_works"><a href="index.html%3Fworks.html" title="部員が製作した作品"><img src="npca/image/normal/cont/works_text.png" alt="部員作品" width="160" height="40" /></a>
<ul class="pull_down">
<li class="menu_top"><p>menu_top</p></li>
<li><a href="index.html%3Fworks=program.html" title="部員が製作したプログラム">プログラム</a></li>
<li><a href="index.html%3Fworks=image.html" title="部員が製作した画像">画像</a></li>
<li><a href="index.html%3Fworks=movie.html" title="部員が製作した動画">動画</a></li>
<li><a href="index.html%3Fworks=tech.html" title="部員が執筆した技術解説">技術解説</a></li>
<li class="menu_bottom"><p>menu_bottom</p></li>
</ul>
</li>
<li id="cont_activity"><a href="index.html%3Factivity.html" title="灘校パソコン研究部の最近の活動"><img src="npca/image/normal/cont/activity_text.png" alt="活動記録" width="160" height="40" /></a>
<ul class="pull_down">
<li class="menu_top"><p>menu_top</p></li>
<li><a href="index.html%3Factivity=old_activity.html" title="過去の活動を年度ごとに整理">過去の活動</a></li>
<li><a href="index.html%3Factivity=all.html" title="全ての活動記録">全記録</a></li>
<li><a href="index.html%3Factivity=kind.html" title="活動記録を種類ごとに分類">種類別</a></li>
<li><a href="index.html%3Factivity=search.html" title="活動記録を検索します">検索</a></li>
<li><a href="index.html%3Factivity=olympic.html" title="情報オリンピック関連の活動記録">情報オリンピック</a></li>
<li class="menu_bottom"><p>menu_bottom</p></li>
</ul>
</li>
<li id="cont_magazine"><a href="index.html%3Fmagazine.html" class="current"><img src="npca/image/normal/cont/magazine_text.png" alt="部誌" width="160" height="40" /></a></li>
<li id="cont_diary"><a href="index.html%3Fdiary.html" title="サイト管理者の日記と部内の様子"><img src="npca/image/normal/cont/diary_text.png" alt="日記" width="160" height="40" /></a>
<ul class="pull_down">
<li class="menu_top"><p>menu_top</p></li>
<li><a href="index.html%3Fdiary=old_diary.html" title="過去の日記を年度ごとに整理">過去の日記</a></li>
<li><a href="index.html%3Fdiary=all.html" title="すべての日記を表示">すべての日記</a></li>
<li><a href="index.html%3Fdiary=admin.html" title="日記を管理者ごとに整理">管理者ごと</a></li>
<li><a href="index.html%3Fdiary=search.html" title="日記を検索します">検索</a></li>
<li class="menu_bottom"><p>menu_bottom</p></li>
</ul>
</li>
<li id="cont_bbs"><a href="index.html%3Fbbs.html" title="コンピュータ関連の内容をディスカッションする掲示板"><img src="npca/image/normal/cont/bbs_text.png" alt="掲示板" width="160" height="40" /></a></li>
<li id="cont_message"><a href="index.html%3Fmessage.html" title="灘校パソコン研究部からのお知らせ"><img src="npca/image/normal/cont/message_text.png" alt="お知らせ" width="160" height="40" /></a>
<ul class="pull_down">
<li class="menu_top"><p>menu_top</p></li>
<li><a href="index.html%3Fmessage=important.html" title="最近の重要なお知らせを表示します">重要なお知らせ</a></li>
<li><a href="index.html%3Fmessage=normal.html" title="最近の通常のお知らせを表示します">通常のお知らせ</a></li>
<li><a href="index.html%3Fmessage=all.html" title="すべてのお知らせを表示します">すべてのお知らせ</a></li>
<li class="menu_bottom"><p>menu_bottom</p></li>
</ul>
</li>
<li id="cont_contact"><a href="index.html%3Fcontact.html" title="灘校パソコン研究部に連絡"><img src="npca/image/normal/cont/contact_text.png" alt="連絡" width="160" height="40" /></a></li>
<li id="cont_others"><a href="index.html%3Fothers.html" title="その他のコンテンツ"><img src="npca/image/normal/cont/others_text.png" alt="その他" width="160" height="40" /></a>
<ul class="pull_down">
<li class="menu_top"><p>menu_top</p></li>
<li><a href="index.html%3Flinks.html" title="他サイト様へのリンク集">リンク集</a></li>
<li><a href="index.html%3Fmembers.html" title="npca部員専用のページ">部員専用</a></li>
<li class="menu_bottom"><p>menu_bottom</p></li>
</ul>
</li>
</ul>
</div>
<div class="main">
<div id="all_main">
<div id="l_main">
<div id="index_box">
<p id="index_title">CUIで始める動画変換</p>
<p id="index_space"><span>space</span></p>
<ul class="index_list">
<li><a href="index.html%3Fmagazine=200701.html#00">前書き</a></li>
<li><a href="index.html%3Fmagazine=200701.html#01">エンコードの前に</a></li>
<li><a href="index.html%3Fmagazine=200701.html#02">エンコード方法の解説</a></li>
<li><a href="index.html%3Fmagazine=200701.html#03">後書き</a></li>
</ul>
<p id="index_bottom"><span>bottom</span></p>
</div>
<div class="main_box">
<h1>CUIで始める動画変換</h1>
<h2 id="00">前書き</h2>
<p>どうやら今年の部誌は量・質ともに不足気味らしくて、それを補う為に何故か私が部誌を書くという事態になっています。実は私は本来部員ではないのですが、部室のサーバや壊れたマシンを復旧したりしているうちに部員の一人として認識されてしまい、今年の部誌の量・質を補う為に何か書いてね〜と相成った訳で...。数年前はパソコン部員の技術もそれなりに高かったはずですが、技術が伝承されておらず、どうも質の良い物が書けていないようです。この部誌も昔の先輩方を引っ張りだして作っているようですね。この先パソコン部大丈夫なんでしょうか。しかし、そんなことを嘆いてもしょうがない。今年は「動画変換」について書く人がいないそうなので、私が書くことにしました。ちなみに、当初は初級編・中級編・上級編と3つに分けて、最初はGUIから入って少しづつCUIに慣れれていく、という方式をとっていたのですが、逐一解説していくと流石に長くなりすぎるので上級編だけにしました(苦笑)そのためかなりマニアックな内容になっていることは否めません。それに、生半可な知識で書いているので見る人が見ればかなり恥ずかしい内容になっているかと思いますが...まぁ部誌の量が稼げるわけですからそれでもいいでしょう(苦笑)</p>
<h2 id="01">エンコードの前に</h2>
<p>さて、前年度の部誌で動画変換について書かれている物と言えば、「録画番組パソコンで！AVI版。」計画再浮上！、ですね。去年の部誌をなくした人はnpcaのホームページにあるのでそちらを読んでください。ここでは動画の変換の基本方針として、「タダ」「軽い」「綺麗」「速い」「人気」の５つをあげています。しかし今回は少し違います。今回の変換の基本方針は画質です。いかにして少ないビットレートで高画質にするか。それが動画変換の永遠のテーマなわけで、今回はその限界に挑んでいこうと思います。去年の部誌では、適当なエンコーダとして「divx」「xvid」「wmv」「x264」の４つが紹介されていましたが、画質を取るならx264で決まりです。ちなみに、snowという、x264よりもさらに先進的なエンコーダもあるようですが、再生互換性や再生負荷のことを考えるとちょっと...。互換性はともかく、再生負荷重すぎです。H.264もさんざん重いと言われましたが、それよりも更に重いです。まぁ、使えない訳ではないので、さらっと説明しておきます。</p>
<p>また、画質を語る上で重要なのはエンコーダの性能だけではありません。ビデオフィルタも重要です。変換前にノイズリダクション、インターレースの解除等を行う必要があり、この性能にかかわってくるのがビデオフィルタです。ノイズリダクションやインターレースの解除をうまくできるか否かで、画質がかなり違ってきます。ここも重要なポイントです。ビデオフィルタの機能を持ち合わせているソフトは、「avisynth」「mencoder」「aviutl」「ffmpeg」等があるのですが...。ここでちょっと言うことがあります。私はMacintosh使いなので、Macintoshを前提として話を進めていきます。あぁ、この時点で更にマニアックになった気がしますが...。気にしないで進めましょう。まぁ、そんなにプラットフォームに依存することは書いてありませんから、WindowsやLinuxでも多少手順が違うだけで応用が効くかと思います。また、Mac OS 9以前をお使いの方は残念ながらここに書いてあることは全く役に立ちません。Mac OS Xにアップグレードすることをお勧めします。さて、aviutlに関しては、AVI出力専用です。(プラグインを組み込めばAVI以外にも出力できますが、実質AVI出力専用です)以前は手軽に高画質が実現できるということで広く使われていたのですが、x264がAVI(VFW)コンテナのサポートを廃止したので実質使えません。x264開発ページに「no more vfw」の告知が出たときは結構騒がれたのですが、まぁいずれにせよaviutlはWindowsでしか使えないので対岸の火事といったところですね。avisynthは、aviutlほど手軽に使えるわけではありませんが、優秀なビデオフィルタです。Windowsを使っているのであればこれを使うべきなのでしょうが、今回はMacintosh向けに書いているので解説しません。さて、Macintoshで一番使えるビデオフィルタは、mencoderです。もともとUNIXのソフトウェアなのでCUIから利用することになるわけです。ffmpegはGUIで利用できる動画変換ソフトで内部的に使われているようですが、ビデオフィルタは貧弱です。ということで、Macintoshでビデオフィルタを選ぶならmencoderに決まりです。</p>
<h2 id="02">エンコード方法の解説</h2>
<p>さて、早速mencoderをダウンロードしてきましょう。本来UNIXのソフトウェアはソースコードだけ置いてあって、勝手に各自ビルドしていってください、といったノリのものが多いのですが、Mac OS Xで動くmencoderのバイナリは有志がビルドしてくれたものがありますから始めのうちはそれを使いましょう。<br />
<a href="http://ffmpegx.com/download.html">http://ffmpegx.com/download.html</a><br />
上記のURLはffmpegXというGUIで動く動画変換のソフトですが、mencoderのバイナリが置いてありますのでそれを使いましょう。<br />
Windows、Linuxのバイナリも探せばあるとは思いますがここでは紹介しません。</p>
<p>当然ですがCUIで動くツールなのでダフルクリックしても開きません。ターミナルから利用します。ここではターミナルの使い方については解説しません。ここに書くと長くなりすぎるので。必要なら自分で調べてください。ところで、mencoderだけ落としてきて、肝心のx264は要らないのかと思われるかもしれませんが、落としてきたmencoderの中にはx264も含まれているので問題ありません。</p>

<p>さて、早速変換してみましょう。ホームフォルダ直下にmencoderと変換したいファイル(ここではhoge.mpegとしています)を置いて、アプリケーションフォルダ内にあるターミナルを開いて以下のコマンドを実行すれば変換できます。ターミナルの扱い方に付いて説明しだすと長くなるのでここでは割愛します。別にMacintoshでなくとも同じコマンドで変換できるはずです。</p>
<p class="noindent">./mencoder hoge.mpeg -nosound -ovc x264 -x264encopts bitrate=1024:bframes=3:b_adapt:weight_b:b_pyramid:keyint=240:keyint_min=1:scenecut=65:qp_min=10:qp_max=51:qp_step=8:qcomp=0.6:ratetol=4:deblock:deblock=0,0:cqm=jvt:cabac:direct_pred=auto:nofast_pskip:nodct_decimate:nointerlaced:noglobal_header:psnr:ssim:pass=1:threads=2:turbo=1 -passlogfile hoge.264.log -vf pullup,softskip,pp=l5,crop=720:480:0:0,scale=640:480:::3,hqdn3d=4:3:6,harddup -sws 9 -ofps 24000/1001 -of rawvideo -o hoge.264<br />
./mencoder hoge.mpeg -nosound -ovc x264 -x264encopts bitrate=1024:bframes=3:b_adapt:weight_b:b_pyramid:keyint=240:keyint_min=1:scenecut=65:qp_min=10:qp_max=51:qp_step=8:qcomp=0.6:ratetol=4:deblock:deblock=0,0:cqm=jvt:cabac:direct_pred=auto:nofast_pskip:nodct_decimate:nointerlaced:noglobal_header:psnr:ssim:pass=2:threads=16:me=umh:me_range=32:subq=7:frameref=4:mixed_refs:8x8dct:partitions=all:trellis=2:brdo:bime -passlogfile hoge.264.log -vf pullup,softskip,pp=l5,crop=720:480:0:0,scale=640:480:::3,hqdn3d=4:3:6,harddup -sws 9 -ofps 24000/1001 -of rawvideo -o hoge.264</p>
<p>(↑ブラウザによって一部自動改行されずに右にはみ出ますが、コピーした際にミスが起きないように無視しました　サーバー管理者より)</p>
<p><a href="http://agehatype0.blog50.fc2.com/">agehaさん</a>の設定です。感謝！
※アニメ用設定ですので、実写では変えましょう。解説読んでください。</p>
<p>な、長いですね...。流れ的には、まず高速な設定で変換し、そこでできた映像ファイルは捨ててログを取得、それを使ってもう一度低速だが高画質な設定でエンコードします。いわゆる２パスエンコードですね。<br />
これからagehaさんの設定に基づいて、オプションを一つずつ解説していきます。
-nosound	サウンドを出力しない。映像を生データで出力し、音声を別途変換してMP4に詰めるのでここでは音声は変換しません。<br />
-ovc x264	エンコーダの指定。x264を使います。<br />
-x264encopts	この後に続く長ったらしいオプションはx264の設定項目です。x264をmencoderを経由せず直接利用した場合は違った書式になるのですが、おおむね対応しているようです。<br />

-passlogfile ログファイルの場所を指定します。２パスエンコードで使います。<br />
-vf	ビデオフィルタのオプションをこのあとに指定します。<br />
-sws	スケーリング(ビデオのリサイズ)の設定。0〜10の間で指定します。数字が大きくなると、輪郭がなめらかにリサイズできますが、その分遅くなります。拡大する場合は結構差が出ますが、縮小・等倍の場合はあまり見た目変わりません。まぁでも、そこまで遅くなるわけでもないので9になっているようです。<br />
-ofps	出力fpsの指定。ビデオフィルタを経由し、インターレースを解除したので出力24fpsとなります。正確には、23.976ですが、より正確には24000/1001です。ここでは分数で指定できるので24000/1001になっています。<br />
-of rawvideo	映像を生データで出力します。後で音声とともにMP4に詰め直すため。<br />
-o hoge.264	出力ファイル名の指定。</p>
<p>-x264encopts のオプションを解説します。ここを弄ることで画質が変わってきます。一部省略してます。<br />
bitrate=1024<br />
ビットレートを指定します。ここでは1024になっていますが、私は768でも十分だと思います。ですが、画質にこだわる場合は1024が良いのでしょう。<br />

subq=7<br />
1〜7の間で指定します。subpel精製品質の調整、らしいですが、そんなこと言われても訳分かりません。単純に、品質の度合いを表す数字と受け取って構わないようです。数字をあげると品質は良くなりますが遅くなります。とはいうものの、この値が低いと効かないオプションもあるので、最低でも5以上にした方が良いです。出来れば7。<br />
frameref=1 frameref=4<br />
変換時に何枚前のフレームまでたどるか、という指標です。増やせば増やす程画質が良くなり速度が遅くなっていくのですが、5あたりで効果が激減します。この値が多いと結構時間がかかるので、1パス目は1、2パス目で4、としているようです。アニメに効果的。<br />
keyint=240 keyint_min=1<br />
GOPの最大値、最小値を指定します。<br />
GOPとはGroup Of Pictureの略で、動画を圧縮する際にはGOP単位に区切って圧縮します。<br />
GOPは、Iフレーム、Pフレーム、Bフレームから構成されています。<br />
Iフレームは、それだけでデコードが可能です。ようするに、jpegやpngの写真のように、それ単体で表示出来るようになっているフレームです。<br />

Pフレームは、デコードするのに直前のIフレームを必要とします。直前のIフレームとの「差分」だけを記録しているのです。その為、アニメの口パク等、ほとんど絵が変わらない場面では非常に圧縮効率が良いです。<br />
Bフレームは、更にPフレームの差分をとった物です。デコードするのに直前のI・Pフレームを必要とします。使いすぎると画質が悪くなることもあります。<br />
よって、実際のデータのならび順としてはこんな感じになる訳です。<br />
IPPPBBIPPPBIPBBBIPPPIP....<br />
(Bフレームはデータのならび順とデコード順が違うのですが、ここでは説明を割愛します)<br />
ここで、IPPPBBまでが１つのGOP、また次のIPPPBがまた一つのGOPです。<br />
Iフレームをシーンチェンジの時において、そのあと少しずつ画面が変わっていく場面でP/Bフレーム、またシーンチェンジが訪れたらIフレームを挿入、としてやって効率良く圧縮していく訳です。<br />
GOPの最大値に設定された値になると、シーンチェンジが訪れていなくても強制的にIフレームを挿入します。つまり、画質的にはマイナスです。しかし、最初からではなく任意の場所から再生したいときは、Iフレームからでないと頭出しが出来ませんからあまりGOPが長いと頭出しがしにくくなってしまいます。つまり、keyintの値は下げれば下げる程頭出しがしやすくなり、画質的にマイナス、ということです。設定する値は240フレーム=10秒分で良いんじゃないかなと思います。頭出しなんか知ったことか！画質を追求する！という方はもの凄く大きくしてやれば望みうる最善画質になります。お勧めしませんが。<br />
GOPの最小値は、この値よりも小さな値でシーンチェンジが訪れたとしても新しいGOPにしません。つまり、画質的にはマイナスです。(Pフレームを挿入する訳ではなく、IDRフレーム等が絡んでくるのですが、ややこしくなるので割愛します。)ですが、実写では一瞬だけ映像を表示して次の瞬間には全く違う映像を表示する、なんてことはあまりないため、最小値を設定しておいた方がより効率よくエンコードできます。keyint_min=30くらいでしょうか。まぁ、バイオハザード アポカリプスの終盤とかフラッシュバック的に連続して映像が表示されることもあるので、そこんとこどうかな〜とはおもいますが。アニメでは一秒未満でシーンチェンジすることも珍しくないので、keyint_min=0もしくは1です。<br />

scenecut=65<br />
シーンチェンジを判定してIフレームを挿入するのですが、どれくらい映像が変わったらIフレームを挿入するか、という指標です。アニメではシーンチェンジが多いので高めに。特にアニメのOPでは更に多くなりますのでこの値よりも更にもう少し高くしても良いでしょう。一方、実写では低めに。scenecut=40(デフォルト)くらい。落語など、ほとんど場面転換がない特殊な場合ではさらに低くします。<br />
bframe=3<br />
連続するBフレームの最大数。例えばbframe=3だと、IPPBBBとなるのが最大でIPBBBBとはなりません。bframe=0にするとBフレームを使いません。画質を求めるならBフレームは使うべきです。<br />
b_adapt <br />
Bフレームの品質に影響するようです。とりあえず使っときましょう。当然bframe=0の場合は意味ありません。<br />
weight_b<br />
前述したようにBフレームは使いすぎると画質が悪くなります。このオプションをつけると、Bフレームに適さないフレームを発見しPフレームにします。bframe=1ならオフ、bframe=2以上ならオンで。<br />
b_pyramid <br />

BフレームはPフレームの差分をとったものですが、このオプションを使うと更にBフレームの差分をとります。その分圧縮効率はよくなります。bframe=2以上でないと意味ありません。<br />
deblock<br />
デブロックフィルタ。これは必ず使うべきです。x264のデブロックは大抵の場合、画質がよくなるのに対し速度はあまり低下しません。アニメに効果的。<br />
deblock=0,0<br />
デブロック強度の指定。-6〜6の間で指定します。大抵の場合、0,0でベストな画質になりますので、素材に忠実にしたい、と思っていても下げるのはお勧めしません。あげるのは、オリジナルの段階で既にブロックノイズがある場合です。deblock=3,3程度でしょう。<br />
cabac<br />
若干遅くなりますが、ビットレートが10%〜15%節約できるので切らない方がいいです。画質には影響しません。<br />
nofast_pskip<br />
Pフレームにおける速い段階でのスキップ検出。通常は画質低下等のペナルティ無しで速度が向上するのです...が、切ることでx264特有の「闇階調でばたばた動くブロックノイズ」を抑えることが出来るので、ここでは切っているようです。実際に自分で試してみて決めることをお勧めします。<br />

nodct_decimate<br />
使うと若干ディテイルを除去するので、余ったビットレートを他に回せます。ここでは切られていますが、低ビットレートで変換する時やアニメでは使った方がいいかもしれません。ある程度ビットレートを見積もって素材に忠実にしたい場合はオフで。<br />
pass=1 pass=2<br />
パスの指定。1が１パス、2が２パス、という意味ではありません。1が最初のパス、2が最後のパス、3がそれ以外のパスです。ですから、たとえば5パスでエンコードしたい場合は13332と変換していくわけです。とはいうものの、５パスもやるともの凄く時間がかかりますし、x264のマルチパスはあまり質がよろしくないようなので３パス程度にするくらいなら２パスにしておいた方が良いです。短編動画ではマルチパスが効果的です。短編故に時間もあまりかからないことですし。<br />
threads=2 threads=16<br />
複数CPUで効率的に変換する為にスレッドを分割。最近、CoreDuoなど、マルチコアのCPUが登場してきましたが(もっともそれより前からマルチコアのCPUはあったのですが)マルチコアのCPUで動画変換を行うと、(２コアなら)２コアのうち１コアしか変換作業をせず、もう片方のCPUが宙ぶらりんな状態になります。それだと非常に勿体ないので、ここで指定された数値だけ作業を分担。複数のCPUに作業させます。分担させると圧縮効率に若干悪影響があるのでシングルコアのCPUを使っているならここのはthreads=1にしましょう。agehaさんのサイトでは、デュアルコアの場合で1パス目はthreads=2、2パス目はthreads=16とするのがもっとも良いという結論に達しています。最近はクアッドコア(４コア)やオクトコア(８コア)のワークステーション(もはやパソコンとは呼ばない)も登場してきました。きっとこれに動画変換をやらせたら気持ちが悪いくらい速くなるんでしょうねぇ...。<br />
turbo=1<br />
ターボモード。１パスで有効。あまり画質に影響しない１パスのオプションを切って、エンコード速度を速くします。0〜2で指定します。1で良いでしょう。0よりは1の方が、2はちょっとオプション切りすぎな気がします。<br />
nointerlaced<br />

映像をインターレースされている物として扱います。mencoderでビデオフィルタでインターレースが解除されてから圧縮するので、当然オフ。<br />
noglobal_header<br />
ヘッダ情報を書き込む。PSPなど一部のプレイヤーで必要になります。正直どっちでもいいです。<br />
psnr ssim<br />
それぞれ素材に対する忠実度を測る指標です。指定すると変換終了時にPSNR値、SSIM値を表示します。<br />
me=umh<br />
動き補償アルゴリズムの選択。次の中から指定します。<br />
dia ダイヤモンド。四角形サーチ。<br />
hex ヘキサゴン。六角形サーチ。<br />

umh マルチヘキサゴン。不等複数六角形サーチ。<br />
esa エクゾースティッド。徹底サーチ。<br />
esaは実用に堪えない程遅いですので使い物になりません。２パス目でumhを使うのがいいでしょう。<br />
me_range=32<br />
me=umh、me=esaで動きを探索する半径を指定します。これもあまり大きくしすぎると遅くなります。重いと思うならme_range=24くらいに下げてもいいかもしれません。<br />
mixed_refs<br />
複数のフレームを参照することで動き補償の精度が向上します。オンにしておきましょう。<br />
partitions=all<br />
動き補償をする際、フレーム全体が同一方向に動くことは少なくてあちらこちらに散らばった動き方をします。そこで、マクロブロックという区画に仕切るのですが、その大きさを指定します。<br />

p16x16,b16x16,i16x16……常に適用。<br />
p16x8,p8x16,p8x8……p8x8<br />
p8x4,p4x8,p4x4……p4x4<br />
b16x8,b8x16,b8x8……b8x8<br />
i8x8……i8x8<br />
i4x4……i4x4<br />
たとえば、p16x16,b16x16,i16x16,i8x8,i4x4の５つを使いたい場合はpartirions=i8x8,i4x4という風に指定します。allを指定すると全て使用。noneを指定するとp16x16,b16x16,i16x16以外は全て使いません。これもagehaさんのサイトで、何も考えずallを指定してよさそう、という結論になっています。<br />
8x8dct<br />
i8x8を使うならオンにしておきましょう。</p>

<p>-vf オプションを解説します。インターレースの解除やノイズの除去に影響します。<br />
pp系は基本的にインターレースをほぼ除去できます。<br />
pp=lb<br />
リニアブレンド。これを使うと完全にインターレースを除去できますが、全体がややボケて、動く物が二重化します。前後のフレームを半分ずつ混ぜ合わせた、ゴーストのようなフレームができます。<br />
pp=l5<br />
pp=lbの弱くした物。pp=lbと比べて副作用が少ないですが、場合によってはインターレースが残ることも。<br />
pp=md<br />
中央値補間。pp系の中では単体で使う分でもっとも良い。デメリットはアニメなどの輪郭にジャギが出ること。<br />
filmdint=fast=0/comb_thres=48<br />

pp=mdよりもクリアで、輪郭ジャギも出ません。デメリットは細かい部分が少しつぶれ、解除もれが出ること。アニメの口パクなどで良く残ります。filmdint内でもオプションがあり、いろいろ挙動が変更できるのですが、ここでは解説しません。Macintoshでは2005年夏頃から正常動作しなくなったようです。yadif=0を使いましょう。<br />
pullup,softskip<br />
逆テレシネフィルタ。正確にはインタレ解除ではありません。インターレースがかかる前の状態に復元することを念頭においているので、アニメでは極めて美しく解除できます。欠点は、インターレースをかけた上から字幕ロゴ等が合成してあるとその部分が荒れること、始めからインターレースのかかった状態で撮影されているような番組では当然正しく解除できません。pullup直後のsoftskipは必ず指定しましょう。<br />
yadif=0<br />
解除性能はfilmdintとほぼ同等。ただ、解除もれを起こさない点でfilmdintに勝ります。<br />
mcdeint=0<br />
新しく登場してきたインタレ解除フィルタです。インタレ解除フィルタのくせに動き補償まで備えています。yadifよりジャギが少なく、設定次第で万能ナイフにもなりそうですがまだ出てきたばかりで未実装の機能等があります。あと、猛烈に遅いです。<br />
hqdn3d=4:3:6<br />
デノイズフィルタ。前から順に、空間軸輝度、空間軸彩度、時間軸のデノイズ強度です。hqdn3d=4:3:6がもっとも良い、という結論になっています。DVDなど、ノイズが入っていない素材では削ってもいいでしょう。<br />

crop=720:480:0:0<br />
クロップ。映像の上下左右を裁ち落とします。上下の黒幕を裁ち落とす際に使います。最初のふたつで残す映像の幅と高さを、あとのふたつで切抜きの開始位置を指定します。注意したいのは、一般的なMPEG2動画は720×480になっています。再生時に、640×480に縮小しているのです。ですから、そこを留意した上で切りぬきましょう。<br />
scale=640:480:::3<br />
スケーリング。上のcropで裁ち落とした映像を指定したサイズにリサイズします。これを省くと、リサイズを行わない、つまりcropしていない場合は720×480になって横に延びた映像になるので必ず指定しましょう。最後の3は、リサイズする際に輪郭の滑らかさなどに影響します。アニメなら3、実写なら4が適切。<br />
harddup<br />
x264で変換する際は必ず指定しましょう。でないと音ズレします。必ずvfオプションの最後に指定すること。</p>
<p>変換が終了すると、拡張子が264のファイルが出来あがります。これはこのままでは再生できません。MP4に映像と音声を入れる必要があります。それにはMP4Boxを使用します。<br />
MP4Boxのバイナリは以下のサイトで取得できます。今度はWindowsやLinuxのバイナリも入っています。<br />
<a href="http://www.tkn.tu-berlin.de/research/evalvid/">http://www.tkn.tu-berlin.de/research/evalvid/</a></p>

<p>MP4Boxをホームフォルダ直下において以下のコマンドを実行します。<br />
./MP4Box -fps 23.976025 -add hoge.264 -add 音声ファイル.mp4 -new hoge.mp4<br />
音声ファイルは、AACのものをつかいます。MPEG2ファイルから音声を抽出するには<a href="http://www.squared5.com/">MPEG Streamclip</a>を使います。抽出したあとは普通にiTunes等で変換すれば良いです。動画ファイルから音声を抽出するには、拡張子はm4aになると思いますが、mp4に変更しておきましょう。-fpsは出力fpsです。小数で指定しないと音ズレします。</p>
<p>コマンドを実行し終わると、hoge.mp4ファイルを生産します。これで完成です。お疲れさまでした。他のファイルは必要ないので削除しても構いません。<br />
なお、QuickTimeでは再生できない場合があります。<a href="http://www.videolan.org/vlc/">VLC</a>や<a href="http://www.mplayerhq.hu/design7/news.html">MPlayer</a>といった再生ソフトを使いましょう。ちなみに、mencoderはmplayerについてくるエンコーダです。mplayerをビルド(コンパイル)するとmencoderもついてきます。本来CUIで動くものですが、GUI版も配布されているので心配せずに。</p>
<p>QuickTimeで再生したい場合には、avc1encoderというプラグインを組み込んでやれば良いのですが、Bフレームを使っているとまた厄介な問題が出てきます。agehaさんも苦労しているようです。暫定的な対応策などがagehaさんのホームページに記載されていますので、それを参照してください。</p>
<h2 id="03">後書き</h2>
<p>どうだったでしょうか？GUIで変換するよりもより高度でマニアックなオプションが使えたことかと思います。これを自分の好みで組み合わせることで、画質の限界に挑めるでしょう。本当はmencoderやx264のビルド(コンパイル)方法も解説したかったのですが、ちょっと部誌を書きはじめるのが遅すぎましたね。というか、今はかなり切羽詰まった状況で書いています。締め切り３日前とかいうレベルを超えてますね。あとで怒られるかも...。まぁそういうわけなので、多少表現がおかしかったとしても気にしないでください。これでmencoderやx264に興味を持ってくれた方ははagehaさんのホームページを参照すると良いです。というか、これ自体がホームページの内容を読みやすくまとめたような形になっていますので。それではまた会う日まで。</p>
<p>61回生 謎の魔人X</p>
</div>
</div><div id="side">
<p id="side_mes"><a href="index.html%3Fmessage.html"><span>重要なお知らせ</span></a></p>
<p id="side_space"><span>space</span></p>
<div class="side_mes_text">
<h1>2010/10/13<br />
更新再開</h1>
<p>サイト担当者問題を解決し、サイトのメンテナンス再開です</p>
</div>
<p id="side_bottom"><span>bottom</span></p>
</div>
</div>
</div>
<address id="copyright">&copy; Copyright 2010 <a href="http://trlocon.ddo.jp/~npca/">npca</a> &amp; <a href="http://mines.dip.jp/">Mine Studio</a>. All rights reserved.</address>
</body>
</html>